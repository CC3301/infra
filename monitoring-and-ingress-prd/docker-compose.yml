version: '3'
services:
  nginx-reverse-proxy:
    build: nginx-reverse-proxy/.
#    image: nginx:latest
#    volumes:
#    - /opt/containerd/data/nginx-reverse-proxy/nginx.conf:/etc/nginx/nginx.conf
    ports:
    - 80:80
    - 443:443
    restart: unless-stopped
    networks:
      monitoring-and-ingress-prd:
        ipv4_address: 172.16.1.2

  # Monitoring Part starts here
  grafana:
    restart: unless-stopped
    image: grafana/grafana:latest

    volumes:
    - /opt/containerd/data/monitoring/grafana_data/:/var/lib/grafana
    - /opt/containerd/data/monitoring/grafana/:/etc/grafana
    user: "root"
    networks:
      monitoring-and-ingress-prd:
        ipv4_address: 172.16.1.10
    
  #influxdb:
  #  restart: unless-stopped
  #  image: influxdb:1.8.5
  #  volumes:
  #  - /opt/containerd/data/monitoring/influxdb:/etc/influxdb

  #  - /opt/containerd/data/monitoring/influxdb_data:/var/lib/influxdb
  #  - /opt/containerd/data/monitoring/influxdb_data2:/var/lib/influxdb2
  #  ports:
  #  - 8086:8086
  #  - "8089:8089/udp"

  #  environment:
  #   - DOCKER_INFLUXDB_INIT_USERNAME=pmx
  #   - DOCKER_INFLUXDB_INIT_PASSWORD=pmx
  #   - DOCKER_INFLUXDB_INIT_ORG=pmx
  #   - DOCKER_INFLUXDB_INIT_BUCKET=proxmox
  #  networks:
  #    monitoring-and-ingress-prd:
  #      ipv4_address: 172.16.1.11

  prometheus:
    restart: unless-stopped
    image: prom/prometheus:latest
    ports:
    - 9090:9090
    volumes:
    - /opt/containerd/data/monitoring/prometheus:/etc/prometheus
    networks:
      monitoring-and-ingress-prd:
        ipv4_address: 172.16.1.12

  # PiHole - Prometheus Bridge
  pihole-prometheus-exporter:
    image: 'ekofr/pihole-exporter:latest'
    environment:
    - PIHOLE_HOSTNAME=pihole0-kch.fink.home,pihole1-tg.fink.home
    - PIHOLE_API_TOKEN=491322461603f606a67431585e063eedc586908538b535384d6b0c9dbd8d5ff2,491322461603f606a67431585e063eedc586908538b535384d6b0c9dbd8d5ff2
    - PORT=9100
    networks:
      monitoring-and-ingress-prd:
        ipv4_address: 172.16.1.20

  # FritzBox - Prometheus Bridge
  fritzbox-prometheus-exporter-fritzbox1-tg.fink.home:
    image: kehrhardt/fritzbox_exporter:latest
    restart: unless-stopped
    environment:
      GATEWAY_URL: "http://192.168.188.1:49000" # ip of your Fritz!Box
      USERNAME: prometheus_bridge_user
      PASSWORD: prometheus_bridge
      LISTEN_ADDRESS: "172.16.1.21:9100"
    networks:
      monitoring-and-ingress-prd:
        ipv4_address: 172.16.1.21
  fritzbox-prometheus-exporter-fritzbox0-kch.fink.home:
    image: kehrhardt/fritzbox_exporter:latest
    restart: unless-stopped
    environment:
      GATEWAY_URL: "http://10.0.0.1:49000" # ip of your Fritz!Box
      USERNAME: prometheus_bridge_user
      PASSWORD: prometheus_bridge
      LISTEN_ADDRESS: "172.16.1.22:9100"
    networks:
      monitoring-and-ingress-prd:
        ipv4_address: 172.16.1.22


networks:
  monitoring-and-ingress-prd:
    driver: bridge
    ipam:
     config:
       - subnet: 172.16.1.0/24
#         gateway: 172.16.1.1